name: Backend CI

on:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    defaults:
      run:
        working-directory: backend

    steps:
      # 1) Fetch repository contents
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Set up the JDK and Gradle cache
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      # 3) Lint Kotlin sources with ktlint
      - name: Lint
        run: ./gradlew ktlintCheck || { echo "::error::Backend lint failed."; exit 1; }

  test:
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
      checks: write

    defaults:
      run:
        working-directory: backend

    steps:
      # 1) Fetch repository contents
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Set up the JDK and Gradle cache
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      # 3) Run unit and integration tests
      - name: Test
        run: ./gradlew test || { echo "::error::Backend tests failed."; exit 1; }

      # 4) Enforce minimum test pass rate (>= 80%)
      - name: Enforce test pass rate
        if: always()
        run: |
          python <<'PY'
          import glob
          import xml.etree.ElementTree as ET

          total = failed = errors = skipped = 0
          report_paths = glob.glob("build/test-results/test/*.xml")
          if not report_paths:
              print("::error::Backend test reports not found.")
              raise SystemExit(1)

          for path in report_paths:
              root = ET.parse(path).getroot()
              suites = [root] if root.tag == "testsuite" else root.findall("testsuite")
              for suite in suites:
                  total += int(suite.attrib.get("tests", 0))
                  failed += int(suite.attrib.get("failures", 0))
                  errors += int(suite.attrib.get("errors", 0))
                  skipped += int(suite.attrib.get("skipped", 0))

          if total == 0:
              print("::error::No backend tests were detected.")
              raise SystemExit(1)

          passed = total - failed - errors - skipped
          rate = passed / total
          print(f"Backend test pass rate: {passed}/{total} ({rate:.0%})")

          if rate < 0.8:
              print("::error::Backend test pass rate below 80%.")
              raise SystemExit(1)
          PY

      # 5) Publish the test report to the GitHub Actions summary
      - name: Publish test report
        if: >
          always() &&
          hashFiles('backend/build/test-results/test/*.xml') != '' &&
          (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
        uses: dorny/test-reporter@v1
        with:
          name: Backend Tests
          path: backend/build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: false

  docker:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    permissions:
      contents: read

    defaults:
      run:
        working-directory: backend

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      # 1) Fetch repository contents
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Prepare multi-platform Docker builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Fail fast with a clear error when secrets are missing
      - name: Validate Docker Hub secrets
        run: |
          if [ -z "${DOCKERHUB_USERNAME}" ] || [ -z "${DOCKERHUB_TOKEN}" ]; then
            echo "::error::Docker Hub secrets are not set."
            exit 1
          fi

      # 4) Authenticate against Docker Hub before pushing
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # 5) Build and push the staging image ("deploy" step for the backend)
      - name: Build and push staging image
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/docker/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/ipa-noten-rechner-backend:staging
            ${{ env.DOCKERHUB_USERNAME }}/ipa-noten-rechner-backend:${{ github.sha }}
