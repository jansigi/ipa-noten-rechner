name: Frontend CI

on:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1) Fetch repository contents
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Set up Node.js and enable npm caching
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # 3) Install frontend dependencies
      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      # 4) Lint TypeScript sources with Angular ESLint
      - name: Lint
        run: npx ng lint || { echo "::error::Frontend lint failed."; exit 1; }
        working-directory: frontend

  test:
    runs-on: ubuntu-latest
    needs: lint

    permissions:
      contents: read
      checks: write

    steps:
      # 1) Fetch repository contents
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Set up Node.js and enable npm caching
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # 3) Install frontend dependencies
      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      # 4) Install Playwright browsers
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        working-directory: frontend

      # 5) Run Playwright tests and generate a JUnit report
      - name: Test
        run: |
          mkdir -p test-results
          if ! npm run test:ci; then
            echo "::error::Frontend tests failed."
            echo "---- junit ----"
            cat test-results/junit.xml || true
            exit 1
          fi
        working-directory: frontend

      # 6) Enforce minimum test pass rate (>= 80%)
      - name: Enforce test pass rate
        if: always()
        run: |
          python <<'PY'
          import xml.etree.ElementTree as ET
          from pathlib import Path

          report_path = Path("frontend/test-results/junit.xml")
          if not report_path.exists():
              print("::error::Frontend test report not found.")
              raise SystemExit(1)

          root = ET.parse(report_path).getroot()
          suites = [root] if root.tag == "testsuite" else root.findall("testsuite")
          total = failed = errors = skipped = 0
          for suite in suites:
              total += int(suite.attrib.get("tests", 0))
              failed += int(suite.attrib.get("failures", 0))
              errors += int(suite.attrib.get("errors", 0))
              skipped += int(suite.attrib.get("skipped", 0))

          if total == 0:
              print("::error::No frontend tests were detected.")
              raise SystemExit(1)

          passed = total - failed - errors - skipped
          rate = passed / total
          print(f"Frontend test pass rate: {passed}/{total} ({rate:.0%})")

          if rate < 0.8:
              print("::error::Frontend test pass rate below 80%.")
              raise SystemExit(1)
          PY

      # 7) Publish the test report to the GitHub Actions summary
      - name: Publish test report
        if: >
          always() &&
          hashFiles('frontend/test-results/junit.xml') != '' &&
          (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
        uses: dorny/test-reporter@v1
        with:
          name: Frontend Tests
          path: frontend/test-results/junit.xml
          reporter: java-junit
          fail-on-error: false

  docker:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    permissions:
      contents: read

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      # 1) Fetch repository contents
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Prepare multi-platform Docker builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Fail fast with a clear error when secrets are missing
      - name: Validate Docker Hub secrets
        run: |
          if [ -z "${DOCKERHUB_USERNAME}" ] || [ -z "${DOCKERHUB_TOKEN}" ]; then
            echo "::error::Docker Hub secrets are not set."
            exit 1
          fi

      # 4) Authenticate against Docker Hub before pushing
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # 5) Build and push the staging image ("deploy" step for the frontend)
      - name: Build and push staging image
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/docker/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/ipa-noten-rechner-frontend:staging
            ${{ env.DOCKERHUB_USERNAME }}/ipa-noten-rechner-frontend:${{ github.sha }}
