name: Frontend CI

on:
  push:
    branches:
      - "**"
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      # Check out repository contents.
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Node.js and enable npm caching.
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Install frontend dependencies.
      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      # Lint TypeScript sources when an ESLint config is present.
      - name: Lint
        run: |
          if [ -f frontend/.eslintrc.cjs ]; then
            npx -y -p eslint -p @typescript-eslint/parser -p @typescript-eslint/eslint-plugin \
              eslint -c frontend/.eslintrc.cjs "frontend/src/**/*.ts" \
              || { echo "::error::Frontend lint failed."; exit 1; }
          else
            echo "No frontend/.eslintrc.cjs found; skipping lint."
          fi

      # Run unit tests and generate a JUnit report.
      - name: Test
        id: tests
        run: |
          mkdir -p test-results
          printf '<testsuite tests="0"></testsuite>' > test-results/junit.xml
          npm run test:ci || { echo "::error::Frontend tests failed."; exit 1; }
        working-directory: frontend

      # Enforce minimum test pass rate (>= 80%).
      - name: Enforce test pass rate
        run: |
          python <<'PY'
          import xml.etree.ElementTree as ET
          from pathlib import Path

          report_path = Path("frontend/test-results/junit.xml")
          if not report_path.exists():
              print("::error::Frontend test report not found.")
              raise SystemExit(1)

          root = ET.parse(report_path).getroot()
          suites = [root] if root.tag == "testsuite" else root.findall("testsuite")
          total = failed = errors = skipped = 0
          for suite in suites:
              total += int(suite.attrib.get("tests", 0))
              failed += int(suite.attrib.get("failures", 0))
              errors += int(suite.attrib.get("errors", 0))
              skipped += int(suite.attrib.get("skipped", 0))

          if total == 0:
              print("::error::No frontend tests were detected.")
              raise SystemExit(1)

          passed = total - failed - errors - skipped
          rate = passed / total
          print(f"Frontend test pass rate: {passed}/{total} ({rate:.0%})")

          if rate < 0.8:
              print("::error::Frontend test pass rate below 80%.")
              raise SystemExit(1)
          PY

      # Publish the test report to the GitHub Actions summary.
      - name: Publish test report
        if: always() && hashFiles('frontend/test-results/junit.xml') != ''
        uses: dorny/test-reporter@v1
        with:
          name: Frontend Tests
          path: frontend/test-results/junit.xml
          reporter: java-junit
          fail-on-error: false

      # Build the production bundle.
      - name: Build
        run: npm run build || { echo "::error::Frontend build failed."; exit 1; }
        working-directory: frontend

      # Build and push the Docker image after successful tests (push events only).
      - name: Set up Docker Buildx
        if: github.event_name == 'push'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build and push image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/docker/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/ipa-noten-rechner-frontend:latest
            ${{ env.DOCKERHUB_USERNAME }}/ipa-noten-rechner-frontend:${{ github.sha }}
