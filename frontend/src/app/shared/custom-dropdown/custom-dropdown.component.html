<div class="dropdown">
  @if (label) {
    <span class="dropdown-label" [id]="labelId">{{ label }}</span>
  }
  <button
    cdkOverlayOrigin
    #trigger="cdkOverlayOrigin"
    type="button"
    class="dropdown-trigger"
    [id]="triggerId"
    [attr.aria-haspopup]="'listbox'"
    [attr.aria-expanded]="open()"
    [attr.aria-controls]="'dropdown-panel'"
    [attr.aria-labelledby]="label ? labelId : null"
    [attr.aria-label]="label ? null : placeholder"
    (click)="toggle()"
    (keydown)="onKeydown($event)"
  >
    <span class="value" [class.placeholder]="!selectedOption">
      {{ selectedOption?.label || placeholder }}
    </span>
    <mat-icon class="chevron" aria-hidden="true">expand_more</mat-icon>
  </button>

  <ng-template
    cdk-connected-overlay
    [cdkConnectedOverlayOrigin]="trigger"
    [cdkConnectedOverlayOpen]="open()"
    [cdkConnectedOverlayHasBackdrop]="true"
    [cdkConnectedOverlayPositions]="[
      { originX: 'start', originY: 'bottom', overlayX: 'start', overlayY: 'top' },
      { originX: 'start', originY: 'top', overlayX: 'start', overlayY: 'bottom' }
    ]"
    (backdropClick)="close()"
    (detach)="close()"
  >
    <div
      #listbox
      id="dropdown-panel"
      class="dropdown-panel"
      role="listbox"
      [attr.aria-activedescendant]="activeIndex() >= 0 ? 'opt-' + activeIndex() : null"
    >
      @for (option of options; track option.value; let idx = $index) {
        <button
          type="button"
          role="option"
          class="dropdown-option"
          [class.selected]="option.value === selected"
          [class.active]="idx === activeIndex()"
          [attr.id]="'opt-' + idx"
          [attr.data-option-idx]="idx"
          [attr.aria-selected]="option.value === selected"
          (click)="select(option)"
        >
          {{ option.label }}
        </button>
      }
    </div>
  </ng-template>
</div>
