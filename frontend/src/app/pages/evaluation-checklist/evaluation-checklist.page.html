<section class="page page-grid">
  <div class="main-column">
    <header class="panel-header sticky">
      <div class="header-grid">
        <div class="title-block">
          <p class="eyebrow">Checkliste</p>
          <h1>Bewertung</h1>
        </div>
        <div class="meta-block" *ngIf="store.selectedPerson() as person; else noPerson">
          <div><span class="label">Name:</span> <strong>{{ person.firstName }} {{ person.lastName }}</strong></div>
          <div><span class="label">Thema:</span> <strong>{{ person.topic }}</strong></div>
          <div><span class="label">Abgabe:</span> <strong>{{ person.submissionDate }}</strong></div>
        </div>
        <ng-template #noPerson>
          <div class="meta-block muted">Keine Person ausgewählt</div>
        </ng-template>
        <div class="jump-block">
          <app-custom-dropdown
            label="Person"
            [placeholder]="personOptions().length ? 'Person wählen' : 'Keine Personen'"
            [options]="personOptions()"
            [selected]="store.selectedPersonId() ?? undefined"
            (selectionChange)="selectPerson($event)"
          ></app-custom-dropdown>
        </div>
        <div class="actions-block">
          <input
            #fileInput
            type="file"
            accept="application/pdf"
            hidden
            (change)="onFileSelected($event)"
          />
          <button mat-flat-button color="primary" (click)="uploadPdf()" [disabled]="loading()">
            <mat-icon aria-hidden="true">upload</mat-icon>
            <span>PDF importieren</span>
          </button>
          <button
            mat-stroked-button
            color="primary"
            (click)="void store.refreshPersonData()"
            [disabled]="store.personDataLoading()"
          >
            <mat-icon aria-hidden="true">refresh</mat-icon>
            <span>Aktualisieren</span>
          </button>
        </div>
      </div>
      <mat-progress-bar mode="determinate" [value]="store.overallCompletionRatio() * 100"></mat-progress-bar>
    </header>

    <div class="status-row">
      <app-error-state
        *ngIf="store.error() as message"
        title="Daten nicht verfügbar"
        [message]="message"
        retryLabel="Erneut versuchen"
        (retry)="void store.refreshPersonData()"
      />
    </div>

    <ng-container *ngIf="!store.personDataLoading() && !store.personIpaDatasetLoading(); else loadingState">
      <ng-container *ngIf="checklistCriteria().length; else emptyCriteria">
        <div class="criteria-scroll">
          <mat-card
            *ngFor="let criterion of checklistCriteria(); trackBy: trackCriterion"
            class="criterion-card"
            #criterionCard
            [attr.data-criterion-id]="criterion.id"
          >
            <div class="criterion-header">
              <div class="code">{{ criterion.id }}</div>
              <div class="titles">
                <h3>{{ criterion.title }}</h3>
                <p class="muted">{{ criterion.question }}</p>
              </div>
              <div class="tag-group" *ngIf="store.resultFor(criterion.id) as result">
                <span class="tag grade">Stufe {{ result.gradeLevel }}</span>
              </div>
            </div>

            <div class="subcriteria">
              <div class="subcriterion" *ngFor="let requirement of criterion.requirements; let idx = index">
                <div class="text">
                  <span class="number">{{ idx + 1 }}.</span>
                  <span>{{ requirement.description }}</span>
                </div>
                <mat-checkbox
                  [checked]="isChecked(criterion.id, requirement.id)"
                  (change)="toggleRequirement(criterion.id, requirement.id)"
                  [aria-label]="'Anforderung ' + (idx + 1) + ' ' + requirement.description"
                ></mat-checkbox>
              </div>
            </div>

            <mat-form-field class="comment-field" appearance="outline">
              <mat-label>Notiz</mat-label>
              <textarea
                matInput
                rows="2"
                [value]="noteFor(criterion.id)"
                (blur)="updateNote(criterion.id, $any($event.target).value)"
              ></textarea>
            </mat-form-field>

            <mat-divider></mat-divider>

            <div class="criterion-footer">
              <div class="evaluation-info" *ngIf="store.evaluationFor(criterion.id) as evaluation">
                <span>Bewertung: {{ evaluation.grade }} / 3</span>
                <span>
                  Erfüllt: {{ evaluation.checkedRequirements }} von {{ evaluation.totalRequirements }}
                </span>
              </div>
              <button mat-button color="warn" (click)="resetCriterion(criterion.id)">Kriterium zurücksetzen</button>
            </div>
          </mat-card>
        </div>
      </ng-container>
    </ng-container>

    <ng-template #loadingState>
      <div class="loading-panel">
        <app-loading message="Bewertung wird geladen..."></app-loading>
      </div>
    </ng-template>

    <ng-template #emptyCriteria>
      <div class="loading-panel muted">
        <p>Für die ausgewählte Person ist noch keine IPA importiert.</p>
        <button mat-stroked-button color="primary" (click)="uploadPdf()" [disabled]="loading()">
          <mat-icon aria-hidden="true">upload</mat-icon>
          <span>PDF importieren</span>
        </button>
      </div>
    </ng-template>
  </div>

  <aside class="eval-column">
    <mat-card class="summary-card">
      <p class="eyebrow">Auswertung</p>
      <h2>Übersicht</h2>

      <div class="summary-line">
        <span class="label-text">Gesamterfüllung</span>
        <span class="grade">{{ formatPercent(store.overallCompletionRatio()) }}</span>
      </div>
      <div class="summary-line">
        <span class="label-text">Ø Bewertungsstufe</span>
        <span class="grade">{{ formatGrade(store.averageGradeLevel()) }}</span>
      </div>


    </mat-card>
  </aside>
</section>
